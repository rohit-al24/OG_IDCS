{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Feedback Results for Form: {{ form.title }}</h2>
    <!-- Comparative Overview Table -->
    <h4>Staff vs. Average Rating & Sentiment</h4>
    <table class="table table-striped table-bordered mb-4">
        <thead>
            <tr>
                <th>Staff</th>
                <th>Avg Rating</th>
                <th>Avg Sentiment Score</th>
            </tr>
        </thead>
        <tbody>
            {% for row in overview_table %}
            <tr>
                <td>{{ row.staff.name }}</td>
                <td>{% if row.avg_rating != None %}{{ row.avg_rating }}{% else %}-{% endif %}</td>
                <td>{% if row.avg_sentiment != None %}{{ row.avg_sentiment }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Department-level Sentiment Pie Chart -->
    <h4>Department Sentiment Distribution</h4>
    <canvas id="deptSentimentPie" width="200" height="200"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {# Output JSON safely for JS #}
    {{ sentiment_labels|json_script:"sentiment-labels" }}
    {{ sentiment_values|json_script:"sentiment-values" }}
    <script>
        const sentimentLabels = JSON.parse(document.getElementById('sentiment-labels').textContent);
        const sentimentValues = JSON.parse(document.getElementById('sentiment-values').textContent);
        const sentimentData = {
            labels: sentimentLabels,
            datasets: [{
                data: sentimentValues,
                backgroundColor: [
                    '#4caf50', // Positive
                    '#fbc02d', // Neutral
                    '#e53935', // Negative
                ],
            }]
        };
        const ctx = document.getElementById('deptSentimentPie').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: sentimentData,
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: false }
                }
            }
        });
    </script>
    <!-- Staff × Aspect Heatmap -->
    <h4>Staff × Aspect Heatmap</h4>
    <canvas id="aspectHeatmap" width="600" height="300"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {{ aspect_labels|json_script:"aspect-labels" }}
    {{ staff_names|json_script:"staff-names" }}
    {{ heatmap_matrix|json_script:"heatmap-matrix" }}
    <script>
        // Prepare data for Chart.js Matrix (heatmap)
        const aspectLabels = JSON.parse(document.getElementById('aspect-labels').textContent);
        const staffNames = JSON.parse(document.getElementById('staff-names').textContent);
        const heatmapMatrix = JSON.parse(document.getElementById('heatmap-matrix').textContent);
        // Convert to Chart.js matrix format
        const data = [];
        for (let i = 0; i < staffNames.length; i++) {
            for (let j = 0; j < aspectLabels.length; j++) {
                data.push({
                    x: aspectLabels[j],
                    y: staffNames[i],
                    v: heatmapMatrix[i][j]
                });
            }
        }
        // Color scale function
        function getColor(val) {
            if (val === null) return '#eee';
            // Green (high) to red (low)
            const min = 0, max = 5;
            const percent = (val - min) / (max - min);
            const r = Math.round(229 - 229 * percent);
            const g = Math.round(76 + (204 - 76) * percent);
            return `rgb(${r},${g},80)`;
        }
        // Chart.js Matrix plugin (if not available, fallback to bar chart)
        const ctxHeat = document.getElementById('aspectHeatmap').getContext('2d');
        new Chart(ctxHeat, {
            type: 'matrix',
            data: {
                datasets: [{
                    label: 'Aspect Scores',
                    data: data,
                    backgroundColor: ctx => getColor(ctx.raw.v),
                    width: ({chart}) => (chart.chartArea || {}).width / aspectLabels.length - 2,
                    height: ({chart}) => (chart.chartArea || {}).height / staffNames.length - 2,
                    borderWidth: 1,
                    borderColor: '#fff',
                }]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: ctx => `Staff: ${ctx[0].raw.y}, Aspect: ${ctx[0].raw.x}`,
                            label: ctx => `Score: ${ctx.raw.v !== null ? ctx.raw.v : 'N/A'}`
                        }
                    }
                },
                scales: {
                    x: { type: 'category', labels: aspectLabels, title: { display: true, text: 'Aspect' } },
                    y: { type: 'category', labels: staffNames, title: { display: true, text: 'Staff' } }
                }
            }
        });
    </script>

    <!-- Per-staff detailed results -->
    <h4>Per-Staff, All-Questions Results</h4>
    <table class="table table-bordered mb-4">
        <thead>
            <tr>
                <th>Staff</th>
                <th>Questions</th>
                <th>Avg Ratings</th>
                <th>Comments</th>
            </tr>
        </thead>
        <tbody>
        {% for result in staff_results %}
            <tr>
                <td>{{ result.staff.name }}</td>
                <td>
                    <ul style="padding-left: 18px;">
                    {% for agg in result.aggregates %}
                        <li>{{ agg.question_id }}</li>
                    {% endfor %}
                    </ul>
                </td>
                <td>
                    <ul style="padding-left: 18px;">
                    {% for agg in result.aggregates %}
                        <li>{{ agg.avg_rating }}</li>
                    {% endfor %}
                    </ul>
                </td>
                <td>
                    <ul style="padding-left: 18px;">
                    {% for agg in result.aggregates %}
                        <li>
                        {% for comment in agg.comments %}
                            <div>{{ comment }}</div>
                        {% endfor %}
                        </li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
