{% extends 'base.html' %}
{% load static %}

{% block mobile_header %}{% endblock %}

{% block root %}
    <!-- Year Filter -->
    <form method="get" class="form-inline mb-3">
        <label for="year" class="mr-2"><b>Filter by Year:</b></label>
        <select name="year" id="year" class="form-control mr-2">
            <option value="">All Years</option>
            <option value="1" {% if request.GET.year == '1' %}selected{% endif %}>1st Year</option>
            <option value="2" {% if request.GET.year == '2' %}selected{% endif %}>2nd Year</option>
            <option value="3" {% if request.GET.year == '3' %}selected{% endif %}>3rd Year</option>
            <option value="4" {% if request.GET.year == '4' %}selected{% endif %}>4th Year</option>
        </select>
        <button type="submit" class="btn btn-primary">Filter</button>
    </form>


    

    <style>
        /* Reuse OD/Leave responsive table styles */
        .od-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: visible;
            overflow-x: auto;
            box-sizing: border-box;
        }
        .od-table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #1976d2;
            color: #fff;
            font-weight: 600;
            font-size: 1.125rem;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .od-header, .od-row {
            display: grid;
            /* six columns: ID, NAME, SUBJECT, STATUS, VIEW, ACTION (Submitted At moved to modal) */
            grid-template-columns: 8% 32% 20% 16% 12% 12%;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            line-height: 1.4;
        }
        .od-header { 
            background: #f5f7fa;
            color: #2c3e50;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .od-header > div { padding: 4px 8px; text-align: left; }
        .od-row { transition: background-color 0.15s ease; }
        .od-row:nth-child(even) { background: #f8fafc; }
        .od-row:hover { background: #f1f5f9; }
        .od-id { font-weight: 600; color: #1976d2; font-family: monospace; font-size: 0.9rem; }
        .od-row > div[data-label="FROM-TO"] { font-size: 0.9rem; white-space: normal; line-height: 1.6; text-align: center; display:flex; flex-direction:column; align-items:center; }
        .od-row > div, .od-header > div { padding: 6px 8px; box-sizing: border-box; min-width: 0; }
        .od-header > div { white-space: nowrap; }
        .od-row > div:nth-child(2), .od-header > div:nth-child(2) { text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .badge { display:inline-block; padding:4px 8px; border-radius:6px; font-weight:500; font-size:0.75rem; min-width:80px; }
        .badge-Approved { background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; }
        .badge-Pending { background:#fffbeb; color:#b45309; border:1px solid #fcd34d; }
        .badge-Rejected { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
        .od-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .od-title { font-weight:500; color:#334155; }
        .status-grid { display:grid; grid-template-columns:auto 1fr; gap:4px 8px; align-items:center; }
        .status-label { color:#4b5563; font-size:0.85rem; font-weight:500; text-align:right; padding-right:4px; }
        @media (max-width:768px) {
            .od-table { padding:8px; }
            .od-header, .od-row { grid-template-columns: 1fr; text-align:left; }
            .od-header div { display:none; }
            .od-row { border:1px solid #e0e0e0; margin-bottom:12px; border-radius:8px; padding:10px; background:#fff; }
            .od-row > div { display:block; padding:6px 0; }
            .od-row > div::before { content: attr(data-label); display:block; font-weight:600; color:#555; margin-bottom:6px; }
            .od-row > div[data-label="NAME"], .od-row > div[data-label="FROM-TO"], .od-row > div[data-label="STATUS"] { white-space:normal; }
            .od-row > div[data-label="VIEW"], .od-row > div[data-label="ACTION"] { display:flex; gap:8px; flex-wrap:wrap; }
            .status-grid { display:flex; flex-direction:column; gap:6px; }
        }

        /* Modal header and modal content to match OD page styling */
        .od-modal-header { background: #1976d2; color: #fff; font-weight: 600; }
        .od-modal-header .modal-title { margin: 0; font-size: 1rem; }
        .modal-content { border-radius: 8px; overflow: hidden; }
    </style>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="od-table">
                    <div class="od-table-header" style="position:relative;display:flex;justify-content:space-between;align-items:center;">
                        <span class="header-title">Mentee Bonafide Forms</span>
                        <a href="{% url 'dash' %}" class="home-icon d-block d-md-none" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:white;">
                            <i class="fa fa-home" aria-hidden="true" aria-label="Home"></i>
                        </a>
                    </div>
                    <hr class="od-divider">
                    <div class="od-header">
                        <div>ID</div>
                        <div>NAME</div>
                        <div>SUBJECT</div>
                        <div>STATUS</div>
                        <div>VIEW</div>
                        <div>ACTION</div>
                    </div>
                    {% with filtered_mentee_bonafides=mentee_bonafides|dictsort:"id" %}
                    {% for b in filtered_mentee_bonafides %}
                        {% if not request.GET.year or b.user.year|stringformat:'s' == request.GET.year %}
                            <div class="od-row">
                                <div class="od-id" data-label="ID">#BF{{ b.id }}</div>
                                <div class="od-title" data-label="NAME" title="{{ b.user.name }}">{{ b.user.name }}</div>
                                <div data-label="SUBJECT">{{ b.sub }}</div>
                                <div data-label="STATUS">
                                    <div class="status-grid">
                                        <div class="status-label">Mentor:</div>
                                        <span class="badge badge-{{ b.Mstatus }}">{{ b.Mstatus }}</span>
                                        <div class="status-label">Advisor:</div>
                                        <span class="badge badge-{{ b.Astatus }}">{{ b.Astatus }}</span>
                                        <div class="status-label">HOD:</div>
                                        <span class="badge badge-{{ b.Hstatus }}">{{ b.Hstatus }}</span>
                                    </div>
                                </div>
                                <div data-label="VIEW">
                                    {% if b.body %}
                                        <button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#reasonModalMentee{{ b.id }}">View Details</button>
                                    {% endif %}
                                    {% if b.proof %}
                                        <a href="{{ b.proof.url }}" class="btn btn-outline-success btn-sm">View File</a>
                                    {% endif %}
                                </div>
                                <div class="od-actions" data-label="ACTION">
                                    <div>
                                        {% if b.Mstatus == 'Pending' and user.username == b.user.mentor.user.username %}
                                            <form method="post" action="{% url 'staff_action_bonafide' b.id %}">{% csrf_token %}
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Action</button>
                                                        <div class="dropdown-menu">
                                                            <button class="dropdown-item set-sts" type="button" data-value="Approved">Approve</button>
                                                            <button class="dropdown-item set-sts" type="button" data-value="Rejected">Reject</button>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" name="sts" value="" class="action-input">
                                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                                </div>
                                            </form>
                                        {% elif b.Astatus == 'Pending' and user.username == b.user.advisor.user.username %}
                                            <form method="post" action="{% url 'staff_action_bonafide' b.id %}">{% csrf_token %}
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Action</button>
                                                        <div class="dropdown-menu">
                                                            <button class="dropdown-item set-sts" type="button" data-value="Approved">Approve</button>
                                                            <button class="dropdown-item set-sts" type="button" data-value="Rejected">Reject</button>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" name="sts" value="" class="action-input">
                                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                                </div>
                                            </form>
                                        {% elif b.Hstatus == 'Pending' and user.username == b.user.hod.user.username %}
                                            <form method="post" action="{% url 'staff_action_bonafide' b.id %}">{% csrf_token %}
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Action</button>
                                                        <div class="dropdown-menu">
                                                            <button class="dropdown-item set-sts" type="button" data-value="Approved">Approve</button>
                                                            <button class="dropdown-item set-sts" type="button" data-value="Rejected">Reject</button>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" name="sts" value="" class="action-input">
                                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                                </div>
                                            </form>
                                        {% else %}
                                            <div class="od-actions">
                                                {% if b.Mstatus == 'Approved' or b.Astatus == 'Approved' or b.Hstatus == 'Approved' %}
                                                    <span class="text-success">Approved</span>
                                                {% elif b.Mstatus == 'Rejected' or b.Astatus == 'Rejected' or b.Hstatus == 'Rejected' or b.AHstatus == 'Rejected' %}
                                                    <span class="text-danger">Rejected</span>
                                                {% else %}
                                                    <span class="text-muted">No action</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if b.body %}
                                <!-- Reason Modal -->
                                <div class="modal fade" id="reasonModalMentee{{ b.id }}" tabindex="-1" role="dialog" aria-labelledby="reasonModalLabelMentee{{ b.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header od-modal-header">
                                                <h5 class="modal-title" id="reasonModalLabelMentee{{ b.id }}">Details for Bonafide #{{ b.id }}</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                                <div class="d-flex justify-content-center" style="padding:0.5rem;">
                                                                    <div class="card" style="width:100%; max-width:900px; border:0; box-shadow:0 6px 18px rgba(0,0,0,0.08);">
                                                                        <div class="card-body" style="padding:1rem 1.25rem; font-family:inherit; color:inherit;">
                                                                            <div style="display:flex; gap:1.25rem; flex-wrap:wrap;">
                                                                                <div style="flex:1 1 320px; min-width:220px;">
                                                                                    <div class="app-details" style="font-size:0.95rem;">
                                                                                        {% if b.fathers_name %}<div class="app-row"><strong>Fathers Name:</strong> <span>{{ b.fathers_name }}</span></div>{% endif %}
                                                                                        {% if b.branch %}<div class="app-row"><strong>Branch:</strong> <span>{{ b.branch }}</span></div>{% endif %}
                                                                                        {% if b.year %}<div class="app-row"><strong>Year:</strong> <span>{{ b.year }}</span></div>{% endif %}
                                                                                        {% if b.community %}<div class="app-row"><strong>Community:</strong> <span>{{ b.community }}</span></div>{% endif %}
                                                                                        {% if b.scholar_type %}<div class="app-row"><strong>Scholar Type:</strong> <span>{{ b.scholar_type }}</span></div>{% endif %}
                                                                                        {% if b.college_bus %}<div class="app-row"><strong>College Bus:</strong> <span>{{ b.college_bus }}</span></div>{% endif %}
                                                                                        {% if b.boarding_point %}<div class="app-row"><strong>Boarding Point:</strong> <span>{{ b.boarding_point }}</span></div>{% endif %}
                                                                                        {% if b.bus_type %}<div class="app-row"><strong>Bus Type:</strong> <span>{{ b.bus_type }}</span></div>{% endif %}
                                                                                        {% if b.bus_fare %}<div class="app-row"><strong>Bus Fare:</strong> <span>{{ b.bus_fare }}</span></div>{% endif %}
                                                                                        {% if b.first_graduate %}<div class="app-row"><strong>First Graduate:</strong> <span>{{ b.first_graduate }}</span></div>{% endif %}
                                                                                        {% if b.gov_mgmt %}<div class="app-row"><strong>Gov/Management:</strong> <span>{{ b.gov_mgmt }}</span></div>{% endif %}
                                                                                        {% if b.date %}<div class="app-row"><strong>Date:</strong> <span>{{ b.date }}</span></div>{% endif %}
                                                                                        {% if b.created %}<div class="app-row"><strong>Submitted At:</strong> <span>{{ b.created|date:"d M Y H:i" }}</span></div>{% endif %}
                                                                                        {% if b.sub %}<div class="app-row"><strong>Purpose:</strong> <span>{{ b.sub }}</span></div>{% endif %}
                                                                                    </div>
                                                                                </div>
                                                                                <div style="flex:1 1 320px; min-width:220px;">
                                                                                    {% if b.body %}
                                                                                    <h6 style="margin-top:0; font-weight:600;">Application Body</h6>
                                                                                    <div class="application-body" data-body="{{ b.body|escapejs }}">
                                                                                        {{ b.body|linebreaksbr }}
                                                                                    </div>
                                                                                    <script>
                                                                                    (function(){
                                                                                        try{
                                                                                            var script = document.currentScript;
                                                                                            var el = script && script.previousElementSibling;
                                                                                            if(!el || !el.classList || !el.classList.contains('application-body')) return;
                                                                                            var raw = el.getAttribute('data-body') || '';
                                                                                            // If pipe-separated KV pairs present, parse into rows and normalize
                                                                                            if(raw.indexOf('|') !== -1 && raw.indexOf(':') !== -1){
                                                                                                var parts = raw.split('|').map(function(s){ return s.trim(); }).filter(function(s){ return s.length>0; });
                                                                                                if(parts.length){
                                                                                                    var container = document.createElement('div');
                                                                                                    container.className = 'app-details';
                                                                                                    parts.forEach(function(p){
                                                                                                        var kv = p.split(':');
                                                                                                        if(kv.length>=2){
                                                                                                                                                            var label = kv.shift().trim();
                                                                                                                                                            label = label.replace(/'/g,'');
                                                                                                                                                            var value = kv.join(':').trim();
                                                                                                                                                            var lkey = label.toLowerCase();
                                                                                                                                                            if(lkey.indexOf('branch') !== -1){
                                                                                                                                                                // normalize spacing around & to 'AI&DS' style
                                                                                                                                                                value = value.replace(/\s*&\s*/g,'&');
                                                                                                                                                            }
                                                                                                                                                            if(value && value[0] && value[0] === value[0].toLowerCase()){
                                                                                                                                                                value = value.charAt(0).toUpperCase() + value.slice(1);
                                                                                                                                                            }
                                                                                                            var row = document.createElement('div'); row.className = 'app-row';
                                                                                                            var strong = document.createElement('strong'); strong.textContent = label + ': ';
                                                                                                            var span = document.createElement('span'); span.textContent = value;
                                                                                                            row.appendChild(strong); row.appendChild(span); container.appendChild(row);
                                                                                                        } else {
                                                                                                            var row = document.createElement('div'); row.className = 'app-row'; row.textContent = p; container.appendChild(row);
                                                                                                        }
                                                                                                    });
                                                                                                    el.innerHTML = '';
                                                                                                    el.appendChild(container);
                                                                                                }
                                                                                            } else {
                                                                                                // fallback: show newline-separated lines as list
                                                                                                var text = raw.replace(/\r\n/g,'\n');
                                                                                                var lines = text.split('\n').map(function(s){ return s.trim(); }).filter(function(s){ return s.length>0; });
                                                                                                if(lines.length){
                                                                                                    var ol = document.createElement('ol');
                                                                                                    ol.style.margin = '0'; ol.style.paddingLeft = '1.25rem';
                                                                                                    lines.forEach(function(line){ var li = document.createElement('li'); li.textContent = line; ol.appendChild(li); });
                                                                                                    el.innerHTML = '';
                                                                                                    el.appendChild(ol);
                                                                                                }
                                                                                            }
                                                                                        }catch(e){ /* fail safe - leave original content */ }
                                                                                    })();
                                                                                    </script>
                                                                                    {% endif %}
                                                                                    {% if b.ahod_reason %}
                                                                                    <h6 style="margin-top:0.5rem; font-weight:600;">AHOD Reason</h6>
                                                                                    <p>{{ b.ahod_reason }}</p>
                                                                                    {% endif %}
                                                                                    {% if b.Hstatus %}
                                                                                    <h6 style="margin-top:0.5rem; font-weight:600;">Status</h6>
                                                                                    <p>{{ b.Hstatus }}</p>
                                                                                    {% endif %}
                                                                                </div>
                                                                            </div>
                                                                            {% if b.proof %}
                                                                            <hr />
                                                                            <div style="display:flex; justify-content:center; padding-top:0.5rem;">
                                                                                {% if ".pdf" in b.proof.url|lower %}
                                                                                    <iframe src="{{ b.proof.url }}" style="width:100%; height:60vh; border:none;"></iframe>
                                                                                {% else %}
                                                                                    <img src="{{ b.proof.url }}" alt="Proof" style="max-width:100%; max-height:60vh; object-fit:contain;" />
                                                                                {% endif %}
                                                                            </div>
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {% if filtered_mentee_bonafides|length == 0 %}
                        <div class="od-row"><div style="grid-column:1/-1;text-align:center;padding:16px;">No mentee bonafide forms.</div></div>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="od-table">
                    <div class="od-table-header"><span class="header-title">Class Bonafide Forms</span></div>
                    <hr class="od-divider">
                    <div class="od-header">
                        <div>ID</div>
                        <div>NAME</div>
                        <div>SUBJECT</div>
                        <div>STATUS</div>
                        <div>VIEW</div>
                        <div>ACTION</div>
                    </div>
                    {% with filtered_class_bonafides=class_bonafides|dictsort:"id" %}
                    {% for b in filtered_class_bonafides %}
                        {% if not request.GET.year or b.user.year|stringformat:'s' == request.GET.year %}
                            <div class="od-row">
                                <div class="od-id" data-label="ID">#BF{{ b.id }}</div>
                                <div class="od-title" data-label="NAME" title="{{ b.user.name }}">{{ b.user.name }}</div>
                                <div data-label="SUBJECT">{{ b.sub }}</div>
                                {# Submitted At moved to modal card only #}
                                <div data-label="STATUS">
                                    <div class="status-grid">
                                        <div class="status-label">Mentor:</div>
                                        <span class="badge badge-{{ b.Mstatus }}">{{ b.Mstatus }}</span>
                                        <div class="status-label">Advisor:</div>
                                        <span class="badge badge-{{ b.Astatus }}">{{ b.Astatus }}</span>
                                        <div class="status-label">HOD:</div>
                                        <span class="badge badge-{{ b.Hstatus }}">{{ b.Hstatus }}</span>
                                    </div>
                                </div>
                                <div data-label="VIEW">
                                    {% if b.body %}
                                        <button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#reasonModal{{ b.id }}">View Details</button>
                                    {% endif %}
                                    {% if b.proof %}
                                        <a href="{{ b.proof.url }}" class="btn btn-outline-success btn-sm">View File</a>
                                    {% endif %}
                                </div>
                                <div class="od-actions" data-label="ACTION">
                                    <div>
                                        {% if b.Mstatus == 'Pending' and user.username == b.user.mentor.user.username %}
                                            <form method="post" action="{% url 'staff_action_bonafide' b.id %}">{% csrf_token %}
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Action</button>
                                                        <div class="dropdown-menu">
                                                            <button class="dropdown-item set-sts" type="button" data-value="Approved">Approve</button>
                                                            <button class="dropdown-item set-sts" type="button" data-value="Rejected">Reject</button>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" name="sts" value="" class="action-input">
                                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                                </div>
                                            </form>
                                        {% elif b.Astatus == 'Pending' and user.username == b.user.advisor.user.username %}
                                            <form method="post" action="{% url 'staff_action_bonafide' b.id %}">{% csrf_token %}
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Action</button>
                                                        <div class="dropdown-menu">
                                                            <button class="dropdown-item set-sts" type="button" data-value="Approved">Approve</button>
                                                            <button class="dropdown-item set-sts" type="button" data-value="Rejected">Reject</button>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" name="sts" value="" class="action-input">
                                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                                </div>
                                            </form>
                                        {% elif b.Hstatus == 'Pending' and user.username == b.user.hod.user.username %}
                                            <form method="post" action="{% url 'staff_action_bonafide' b.id %}">{% csrf_token %}
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Action</button>
                                                        <div class="dropdown-menu">
                                                            <button class="dropdown-item set-sts" type="button" data-value="Approved">Approve</button>
                                                            <button class="dropdown-item set-sts" type="button" data-value="Rejected">Reject</button>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" name="sts" value="" class="action-input">
                                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                                </div>
                                            </form>
                                        {% else %}
                                            <div class="od-actions">
                                                {% if b.Mstatus == 'Approved' or b.Astatus == 'Approved' or b.Hstatus == 'Approved' %}
                                                    <span class="text-success">Approved</span>
                                                {% elif b.Mstatus == 'Rejected' or b.Astatus == 'Rejected' or b.Hstatus == 'Rejected' or b.AHstatus == 'Rejected' %}
                                                    <span class="text-danger">Rejected</span>
                                                {% else %}
                                                    <span class="text-muted">No action</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if b.body %}
                                <!-- Reason Modal -->
                                <div class="modal fade" id="reasonModal{{ b.id }}" tabindex="-1" role="dialog" aria-labelledby="reasonModalLabel{{ b.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header od-modal-header">
                                                <h5 class="modal-title" id="reasonModalLabel{{ b.id }}">Details for Bonafide #{{ b.id }}</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="d-flex justify-content-center" style="padding:0.5rem;">
                                                    <div class="card" style="width:100%; max-width:900px; border:0; box-shadow:0 6px 18px rgba(0,0,0,0.08);">
                                                        <div class="card-body" style="padding:1rem 1.25rem; font-family:inherit; color:inherit;">
                                                            <div style="display:flex; gap:1.25rem; flex-wrap:wrap;">
                                                                <div style="flex:1 1 320px; min-width:220px;">
                                                                    <div class="app-details" style="font-size:0.95rem;">
                                                                        {% if b.fathers_name %}<div class="app-row"><strong>Fathers Name:</strong> <span>{{ b.fathers_name }}</span></div>{% endif %}
                                                                        {% if b.branch %}<div class="app-row"><strong>Branch:</strong> <span>{{ b.branch }}</span></div>{% endif %}
                                                                        {% if b.year %}<div class="app-row"><strong>Year:</strong> <span>{{ b.year }}</span></div>{% endif %}
                                                                        {% if b.community %}<div class="app-row"><strong>Community:</strong> <span>{{ b.community }}</span></div>{% endif %}
                                                                        {% if b.scholar_type %}<div class="app-row"><strong>Scholar Type:</strong> <span>{{ b.scholar_type }}</span></div>{% endif %}
                                                                        {% if b.college_bus %}<div class="app-row"><strong>College Bus:</strong> <span>{{ b.college_bus }}</span></div>{% endif %}
                                                                        {% if b.boarding_point %}<div class="app-row"><strong>Boarding Point:</strong> <span>{{ b.boarding_point }}</span></div>{% endif %}
                                                                        {% if b.bus_type %}<div class="app-row"><strong>Bus Type:</strong> <span>{{ b.bus_type }}</span></div>{% endif %}
                                                                        {% if b.bus_fare %}<div class="app-row"><strong>Bus Fare:</strong> <span>{{ b.bus_fare }}</span></div>{% endif %}
                                                                        {% if b.first_graduate %}<div class="app-row"><strong>First Graduate:</strong> <span>{{ b.first_graduate }}</span></div>{% endif %}
                                                                        {% if b.gov_mgmt %}<div class="app-row"><strong>Gov/Management:</strong> <span>{{ b.gov_mgmt }}</span></div>{% endif %}
                                                                        {% if b.date %}<div class="app-row"><strong>Date:</strong> <span>{{ b.date }}</span></div>{% endif %}
                                                              {% if b.created %}<div class="app-row"><strong>Submitted At:</strong> <span>{{ b.created|date:"d M Y H:i" }}</span></div>{% endif %}
                                                              {% if b.sub %}<div class="app-row"><strong>Purpose:</strong> <span>{{ b.sub }}</span></div>{% endif %}
                                                                    </div>
                                                                </div>
                                                                <div style="flex:1 1 320px; min-width:220px;">
                                                                    {% if b.body %}
                                                                    <h6 style="margin-top:0; font-weight:600;">Application Body</h6>
                                                                    <div class="application-body" data-body="{{ b.body|escapejs }}">
                                                                        {{ b.body|linebreaksbr }}
                                                                    </div>
                                                                    <script>
                                                                    (function(){
                                                                        try{
                                                                            var script = document.currentScript;
                                                                            var el = script && script.previousElementSibling;
                                                                            if(!el || !el.classList || !el.classList.contains('application-body')) return;
                                                                            var raw = el.getAttribute('data-body') || '';
                                                                            if(raw.indexOf('|') !== -1 && raw.indexOf(':') !== -1){
                                                                                var parts = raw.split('|').map(function(s){ return s.trim(); }).filter(function(s){ return s.length>0; });
                                                                                if(parts.length){
                                                                                    var container = document.createElement('div');
                                                                                    container.className = 'app-details';
                                                                                    parts.forEach(function(p){
                                                                                        var kv = p.split(':');
                                                                                        if(kv.length>=2){
                                                                                            var label = kv.shift().trim();
                                                                                            label = label.replace(/'/g,'');
                                                                                            var value = kv.join(':').trim();
                                                                                            var lkey = label.toLowerCase();
                                                                                            if(lkey.indexOf('branch') !== -1){
                                                                                                value = value.replace(/\s*&\s*/g,'&');
                                                                                            }
                                                                                            if(value && value[0] && value[0] === value[0].toLowerCase()){
                                                                                                value = value.charAt(0).toUpperCase() + value.slice(1);
                                                                                            }
                                                                                            var row = document.createElement('div'); row.className = 'app-row';
                                                                                            var strong = document.createElement('strong'); strong.textContent = label + ': ';
                                                                                            var span = document.createElement('span'); span.textContent = value;
                                                                                            row.appendChild(strong); row.appendChild(span); container.appendChild(row);
                                                                                        } else { var row = document.createElement('div'); row.className = 'app-row'; row.textContent = p; container.appendChild(row); }
                                                                                    });
                                                                                    el.innerHTML = '';
                                                                                    el.appendChild(container);
                                                                                }
                                                                            } else {
                                                                                var text = raw.replace(/\r\n/g,'\n');
                                                                                var lines = text.split('\n').map(function(s){ return s.trim(); }).filter(function(s){ return s.length>0; });
                                                                                if(lines.length){
                                                                                    var ol = document.createElement('ol');
                                                                                    ol.style.margin = '0'; ol.style.paddingLeft = '1.25rem';
                                                                                    lines.forEach(function(line){ var li = document.createElement('li'); li.textContent = line; ol.appendChild(li); });
                                                                                    el.innerHTML = '';
                                                                                    el.appendChild(ol);
                                                                                }
                                                                            }
                                                                        }catch(e){ /* fail safe - leave original content */ }
                                                                    })();
                                                                    </script>
                                                                    {% endif %}
                                                                    {% if b.ahod_reason %}
                                                                    <h6 style="margin-top:0.5rem; font-weight:600;">AHOD Reason</h6>
                                                                    <p>{{ b.ahod_reason }}</p>
                                                                    {% endif %}
                                                                    {% if b.Hstatus %}
                                                                    <h6 style="margin-top:0.5rem; font-weight:600;">Status</h6>
                                                                    <p>{{ b.Hstatus }}</p>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            {% if b.proof %}
                                                            <hr />
                                                            <div style="display:flex; justify-content:center; padding-top:0.5rem;">
                                                                {% if ".pdf" in b.proof.url|lower %}
                                                                    <iframe src="{{ b.proof.url }}" style="width:100%; height:60vh; border:none;"></iframe>
                                                                {% else %}
                                                                    <img src="{{ b.proof.url }}" alt="Proof" style="max-width:100%; max-height:60vh; object-fit:contain;" />
                                                                {% endif %}
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {% if filtered_class_bonafides|length == 0 %}
                        <div class="od-row"><div style="grid-column:1/-1;text-align:center;padding:16px;">No class bonafide forms.</div></div>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

{% endblock %}

<script>
// Enable/disable submit buttons and ensure action is selected before submit
document.addEventListener('DOMContentLoaded', function(){
    // Disable submit by default for forms that use .action-input
    document.querySelectorAll('form').forEach(function(form){
        if(form.querySelector && form.querySelector('.action-input')){
            var submit = form.querySelector('button[type="submit"]');
            if(submit) submit.disabled = true;
        }
    });

    // Click handler for dropdown items to set hidden input and enable submit
    document.addEventListener('click', function(e){
        var btn = e.target.closest && e.target.closest('.set-sts');
        if(!btn) return;
        var form = btn.closest('form');
        if(!form) return;
        var input = form.querySelector('.action-input');
        if(input) input.value = btn.getAttribute('data-value') || '';
        // enable submit button
        var submit = form.querySelector('button[type="submit"]');
        if(submit) submit.disabled = false;
        // change the dropdown label to selected value for visual feedback
        var group = btn.closest('.btn-group');
        if(group){
            var toggle = group.querySelector('.dropdown-toggle');
            if(toggle) toggle.textContent = btn.textContent.trim();
        }
    });

    // Submit guard: ensure action-input has a value
    document.addEventListener('submit', function(e){
        var form = e.target;
        if(!(form && form.querySelector)) return;
        var input = form.querySelector('.action-input');
        if(!input) return; // not one of our action forms
        if(!input.value || input.value.trim() === ''){
            e.preventDefault();
            // simple inline user feedback
            var orig = form.querySelector('.btn-group .dropdown-toggle');
            if(orig){
                orig.classList.add('btn-warning');
                setTimeout(function(){ orig.classList.remove('btn-warning'); }, 1500);
            }
            alert('Please select Approve or Reject from the Action dropdown before submitting.');
            return false;
        }
        // allow submit
    }, true);
});
</script>
