{% extends 'base.html' %}
{% load static %}



{% block root %}
<!-- Year Filter -->
<form method="get" class="form-inline mb-3">
    <label for="year" class="mr-2"><b>Filter by Year:</b></label>
    <select name="year" id="year" class="form-control mr-2">
        <option value="">All Years</option>
        <option value="1" {% if request.GET.year == '1' %}selected{% endif %}>1st Year</option>
        <option value="2" {% if request.GET.year == '2' %}selected{% endif %}>2nd Year</option>
        <option value="3" {% if request.GET.year == '3' %}selected{% endif %}>3rd Year</option>
        <option value="4" {% if request.GET.year == '4' %}selected{% endif %}>4th Year</option>
    </select>
    <button type="submit" class="btn btn-primary">Filter</button>
</form>

<style>
    /* Canonical OD styles copied for parity */
    .od-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        overflow: hidden;
    }

    .od-table-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: #1976d2;
        color: #fff;
        font-weight: 600;
        font-size: 1.25rem;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    .od-table-header .header-title { margin: 0; }
    hr.od-divider { margin: 0; border: 0; border-top: 2px solid #e0e0e0; }

    .od-header,
    .od-row {
        display: grid;
        grid-template-columns: 100px 1fr 120px 120px 140px 160px 220px;
        align-items: center;
        gap: 10px;
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
    }

    .od-header { background: #f1f1f1; color: #333; font-weight: 600; text-align: center; }
    .od-row:nth-child(even) { background: #f9f9f9; }
    .od-id { font-weight: 700; color: #1976d2; }

    .badge { padding: 5px 10px; border-radius: 12px; font-weight: 600; color: #fff; font-size: 0.8rem; }
    .badge-Approved { background: #4caf50; }
    .badge-Pending { background: #ff9800; }
    .badge-Rejected { background: #f44336; }
    .badge-secondary { background: #9e9e9e; }

    .od-actions { display: flex; flex-direction: column; gap: 6px; }
    .od-actions input[type="file"] { display: none; }
    .file-upload-label,
    .btn-upload,
    .btn-outline-primary {
        padding: 6px 10px; border-radius: 6px; font-weight: 600; cursor: pointer; text-align: center; font-size: 0.85rem;
    }
    .file-upload-label { background: #1976d2; color: #fff; }
    .file-upload-label:hover { background: #1565c0; }
    .btn-upload { background: #4caf50; border: none; color: #fff; }
    .btn-upload:hover { background: #388e3c; }

    @media (max-width: 768px) {
        .od-table { padding: 10px; }
        .od-header, .od-row { grid-template-columns: 1fr; text-align: left; }
        .od-header div { display: none; }
        .od-row { border: 1px solid #e0e0e0; margin-bottom: 12px; border-radius: 8px; padding: 10px; background: #fff; }
        .od-row > div { display: flex; justify-content: space-between; padding: 4px 0; }
        .od-row > div::before { content: attr(data-label); font-weight: 600; color: #555; }
    }
</style>


<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="od-table">
                <div class="od-table-header"><span class="header-title">Mentees Leaves</span></div>
                <hr class="od-divider">
                <div class="od-header">
                    <div>ID</div>
                    <div>NAME</div>
                    <div>SUB</div>
                    <div>FROM - TO</div>
                    <div>Submitted At</div>
                    <div>STATUS</div>
                    <div>ACTION</div>
                </div>
                {% with filtered_mods=mods|dictsort:"id" %}
                {% for i in filtered_mods %}
                    {% if not request.GET.year or i.user.year|stringformat:'s' == request.GET.year %}
                        <div class="od-row">
                            <div class="od-id" data-label="ID">#LE{{ i.id }}</div>
                            <div class="od-title" data-label="NAME" title="{{ i.user.name }}">{{ i.user.name }}</div>
                            <div data-label="SUB">{{ i.sub }}</div>
                            <div data-label="FROM-TO">{{ i.start }}<br>{{ i.end }}</div>
                            <div data-label="Submitted At">{{ i.created|date:"d M Y H:i" }}</div>
                            <div data-label="STATUS">
                                <div class="status-grid">
                                    <div class="status-label">Mentor:</div>
                                    <span class="badge badge-{{ i.Mstatus }}">{{ i.Mstatus }}</span>
                                    <div class="status-label">Advisor:</div>
                                    <span class="badge badge-{{ i.Astatus }}">{{ i.Astatus }}</span>
                                    <div class="status-label">AHOD:</div>
                                    <span class="badge badge-{{ i.AHstatus }}">{{ i.AHstatus }}</span>
                                    <div class="status-label">HOD:</div>
                                    <span class="badge badge-{{ i.Hstatus }}">{{ i.Hstatus }}</span>
                                </div>
                            </div>
                            <div class="od-actions" data-label="ACTION">
                                <div data-label="VIEW">
                                    <button type="button" class="file-upload-label" data-toggle="modal" data-target="#detail{{i.id}}"><small>VIEW</small></button>
                                    {% if i.proof %}
                                        <a href="{{i.proof.url}}" class="btn-upload">View File</a>
                                    {% endif %}
                                </div>
                                <div data-label="ACTION">
                                    {% if i.Mstatus == "Approved" %}
                                        <button class="btn-upload">{{ i.Mstatus }}</button>
                                    {% elif i.Mstatus == "Rejected" %}
                                        <button class="btn-outline-primary">{{ i.Mstatus }}</button>
                                    {% else %}
                                        <form action="{% url 'hod_action_leave' i.id %}" method="POST">{% csrf_token %}
                                            <input type="hidden" name="role" value="mentor">
                                            <div class="od-actions"><select name="sts" class="form-control"><option value="Approved">Approve</option><option value="Rejected">Reject</option></select><button type="submit" class="btn-upload">Submit</button></div>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                {% if filtered_mods|length == 0 %}
                    <div class="od-row"><div style="grid-column:1/-1;text-align:center;padding:16px;">No records found</div></div>
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="od-table">
                <div class="od-table-header"><span class="header-title">Department Leaves</span></div>
                <hr class="od-divider">
                <div class="od-header">
                    <div>ID</div>
                    <div>NAME</div>
                    <div>SUB</div>
                    <div>FROM - TO</div>
                    <div>Submitted At</div>
                    <div>STATUS</div>
                    <div>ACTION</div>
                </div>
                {% with filtered_hods=hods|dictsort:"id" %}
                {% for i in filtered_hods %}
                    <div class="od-row">
                        <div class="od-id" data-label="ID">#LE{{ i.id }}</div>
                        <div class="od-title" data-label="NAME" title="{{ i.user.name }}">{{ i.user.name }}</div>
                        <div data-label="SUB">{{ i.sub }}</div>
                        <div data-label="FROM-TO">{{ i.start }}<br>{{ i.end }}</div>
                        <div data-label="Submitted At">{{ i.created|date:"d M Y H:i" }}</div>
                        <div data-label="STATUS">
                            <div class="status-grid">
                                <div class="status-label">Mentor:</div>
                                <span class="badge badge-{{ i.Mstatus }}">{{ i.Mstatus }}</span>
                                <div class="status-label">Advisor:</div>
                                <span class="badge badge-{{ i.Astatus }}">{{ i.Astatus }}</span>
                                <div class="status-label">AHOD:</div>
                                <span class="badge badge-{{ i.AHstatus }}">{{ i.AHstatus }}</span>
                                <div class="status-label">HOD:</div>
                                <span class="badge badge-{{ i.Hstatus }}">{{ i.Hstatus }}</span>
                            </div>
                        </div>
                        <div class="od-actions" data-label="ACTION">
                            <div data-label="VIEW">
                                <button type="button" class="file-upload-label" data-toggle="modal" data-target="#detail{{i.id}}"><small>VIEW</small></button>
                                {% if i.proof %}
                                    <a href="{{i.proof.url}}" class="btn-upload">View File</a>
                                {% endif %}
                            </div>
                            <div data-label="ACTION">
                                {% if i.ahod_hod_action == "Approved_AHOD_HOD" %}
                                    <button class="btn-upload">Approved (AHOD &amp; HOD)</button>
                                    {% if i.ahod_hod_reason %}
                                        <div class="mt-2"><span class="badge badge-info">AHOD Reason for HOD: {{ i.ahod_hod_reason }}</span></div>
                                    {% endif %}
                                {% elif i.ahod_hod_action == "Rejected_AHOD_HOD" %}
                                    <button class="btn-outline-primary">Rejected (AHOD &amp; HOD)</button>
                                    {% if i.ahod_hod_reason %}
                                        <div class="mt-2"><span class="badge badge-info">AHOD Reason for HOD: {{ i.ahod_hod_reason }}</span></div>
                                    {% endif %}
                                {% elif i.Hstatus == "Approved" %}
                                    <button class="btn-upload">{{ i.Hstatus }}</button>
                                    {% if i.ahod_hod_reason %}
                                        <div class="mt-2"><span class="badge badge-info">AHOD Reason for HOD: {{ i.ahod_hod_reason }}</span></div>
                                    {% endif %}
                                {% elif i.Hstatus == "Rejected" %}
                                    <button class="btn-outline-primary">{{ i.Hstatus }}</button>
                                    {% if i.ahod_hod_reason %}
                                        <div class="mt-2"><span class="badge badge-info">AHOD Reason for HOD: {{ i.ahod_hod_reason }}</span></div>
                                    {% endif %}
                                {% else %}
                                    <form action="{% url 'hod_action_leave' i.id %}" method="POST">{% csrf_token %}
                                        <input type="hidden" name="role" value="hod">
                                        <div class="od-actions">
                                            <select name="sts" class="form-control">
                                                <option value="Approved">Approve</option>
                                                <option value="Rejected">Reject</option>
                                            </select>
                                            <button type="submit" class="btn-upload">Submit</button>
                                        </div>
                                    </form>
                                    {% if i.ahod_hod_reason %}
                                        <div class="mt-2"><span class="badge badge-info">AHOD Reason for HOD: {{ i.ahod_hod_reason }}</span></div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% if filtered_hods|length == 0 %}
                    <div class="od-row"><div style="grid-column:1/-1;text-align:center;padding:16px;">No records found</div></div>
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>
</div>

<!-- Inline per-item modals are unchanged and still available where they exist in the original loops -->

<script>
    $('#detail').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget)
        var recipient = button.data('sub')
        var name = button.data('name')
        var content = button.data('body')
        var url = button.data('url') || ''
        var modal = $(this)
        modal.find('.modal-title').html(`<b>${recipient}</b>  <small>-by ${name}</small>`)
        modal.find('.modal-body').text(content)

        if (url) {
            modal.find('.modal-footer').html(`
                <div class="btn-group">
                    <a href="${url}" download class="btn btn-outline-success">Download File</a>
                    <a href="${url}" target="_blank" class="btn btn-outline-warning">View File</a>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            `)
        } else {
            modal.find('.modal-footer').html(`
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" disabled>No file uploaded</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            `)
        }
    })
</script>
{% endblock %}
